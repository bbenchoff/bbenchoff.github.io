<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ site.title | default: site.github.repository_name }}</title>
    <link rel="stylesheet" href="/assets/css/scrollbars.css">
    <style>
        @font-face {
            font-family: 'ChicagoFLF';
            src: url('/assets/fonts/ChicagoFLF.ttf') format('truetype');
        }

        :root {
            --system7-bg: #ffffff;
            --system7-text: #000000;
            --system7-window-bg: #ffffff;
            --system7-border: #000000;
            --system7-menubar-bg: #ffffff;
            --system7-titlebar-active: linear-gradient(
                to bottom,
                #d8d8d8 0%,
                #d8d8d8 4px,
                #000000 4px,
                #000000 5px,
                #d8d8d8 5px,
                #d8d8d8 7px,
                #000000 7px,
                #000000 8px,
                #d8d8d8 8px,
                #d8d8d8 10px,
                #000000 10px,
                #000000 11px,
                #d8d8d8 11px,
                #d8d8d8 13px,
                #000000 13px,
                #000000 14px,
                #d8d8d8 14px,
                #d8d8d8 16px,
                #000000 16px,
                #000000 17px,
                #d8d8d8 17px,
                #d8d8d8 19px,
                #000000 19px,
                #000000 20px,
                #d8d8d8 20px,
                #d8d8d8 22px
            );
            --system7-titlebar-inactive: #FFFFFF;
        }

        html, body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        height: 100vh;
        }

        .system7 {
            background-color: var(--system7-bg);
            font-family: 'ChicagoFLF', -apple-system, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .menubar {
            background: var(--system7-menubar-bg);
            border-bottom: 1px solid var(--system7-border);
            display: flex;
            padding: 2px 0;
            height: 20px;
            user-select: none;
            z-index: 1000;
            justify-content: space-between;
            align-items: center;
        }

        .menubar-left {
            display: flex;
        }

        .desktop {
            flex: 1;
            position: relative;
            overflow: hidden !important;
            overflow-y: hidden;
            background: url('/assets/images/backgrounds/MacOS.jpg') no-repeat center center fixed;
            background-size: cover;
            padding-right: 20px;
        }

        .menubar-item {
            padding: 0 10px;
            cursor: default;
        }

        .menubar-item:hover {
            background: #000;
            color: #fff;
        }

        .menubar-item img {
            width: 16px; /* Increased width */
            height: 16px; /* Increased height */
        }

        .window {
            position: absolute;
            background: var(--system7-window-bg);
            border: 1px solid var(--system7-border);
            min-width: 200px;
            min-height: 100px;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.2);
            resize: both;
            overflow: hidden;
        }

        .window-titlebar {
            background: var(--system7-titlebar-active);
            color: white;
            padding: 2px 5px;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 20px;
            position: relative;
        }

        .window-title {
            text-align: center;
            flex-grow: 1;
            background: #ffffff;
            color: black;
            padding: 0 5px;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }


        .window-titlebar.inactive .window-title {
            background: #ffffff;
        }

        .window-close {
            width: 12px;
            height: 12px;
            border: 1px solid #000;
            background: #fff;
            cursor: pointer;
            position: relative;
        }

        .window-close:active {
            background: #000;
        }


        .window-content {
            padding: 10px;
            overflow: auto;
            height: calc(100% - 42px);
            position: relative;
            font-family: Arial, Geneva, sans-serif; /* Ensure text uses Arial */
        }

        .window-content img {
            max-width: 100%; /* Ensure images resize to the current width of the page */
            height: auto;
        }

        .window-content::-webkit-scrollbar-button:vertical:increment {
            display: none;
        }

        /* Resize handle 
        .window {
            resize: both;
        }
        */

        .window-resizer {
            position: absolute;
            right: 0;
            bottom: 0;
            width: 14px;
            height: 14px;
            background: #dedede;
            border: 1px solid #000;
            box-shadow: inset 1px 1px 0 #fff, inset -1px -1px 0 #bcbcbc;
            cursor: se-resize;
            z-index: 1;
        }


        .window.resizable::after {
            content: '';
            position: absolute;
            right: 0;
            bottom: 0;
            width: 14px;
            height: 14px;
            background: #c0c0c0;
            border: 1px solid #000;
            cursor: se-resize;
        }

        /* Icons in folder windows keep their grid layout */
        .folder-window .desktop-icon {
            position: relative;
            width: 100px; /* Adjusted width */
            height: 100px; /* Adjusted height */
        }

        /* Desktop-specific icon styling */
        .desktop > .desktop-icon {
            position: absolute;
            right: 20px;
            width: 100px;
            text-align: center;
            margin-bottom: 20px;
        }


        .folder-window .window-content {
            display: grid;
            grid-template-columns: repeat(auto-fill, 100px); /* Adjusted column width */
            grid-auto-rows: 100px; /* Adjusted row height */
            gap: 10px;
            padding: 10px;
            justify-content: start;
        }

        .desktop-icon {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100px;
            height: 100px;
            cursor: pointer;
            padding: 5px;
        }

        .desktop-icon:hover .desktop-icon-label {
            background: #000;
            color: #fff;
        }

        .desktop-icon img {
            width: 32px;
            height: 32px;
            margin-bottom: 5px;
            pointer-events: none;
        }

        .desktop-icon-label {
            text-align: center;
            color: var(--system7-text);
            font-size: 12px;
            word-wrap: break-word;
            padding: 1px 4px;
            pointer-events: none;
            font-family: Arial, Geneva, sans-serif;
            background: #fff;
            border: 1px solid #000;
            max-width: 90px;
            overflow-wrap: break-word;
        }

        .desktop-icon.alias .desktop-icon-label {
            font-style: italic;
        }

        .dropdown-menu {
            position: absolute;
            top: 24px; /* This positions it below the menubar */
            background: var(--system7-menubar-bg);
            border: 1px solid var(--system7-border);
            box-shadow: 2px 2px 0 rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            min-width: 160px;
        }

        .dropdown-item {
            padding: 2px 20px;
            cursor: default;
            white-space: nowrap;
        }

        .dropdown-item:hover {
            background: #000;
            color: #fff;
        }

        .dropdown-divider {
            height: 1px;
            background: var(--system7-border);
            margin: 2px 0;
        }

        @media (max-width: 768px) {
            .window {
                width: 100% !important;
                height: calc(100% - 20px) !important;
                top: 20px !important;
                left: 0 !important;
                resize: none;
            }
        }

        .clock {
            padding: 0 10px;
            color: var(--system7-text);
            font-family: 'ChicagoFLF', -apple-system, sans-serif;
        }

    </style>
</head>
<body>
    <div id="system7" class="system7">
        <div class="menubar">
            <div class="menubar-left">
                <div class="menubar-item" data-menu="apple">
                    <img src="/assets/images/apple-logo.png" alt="" width="12" height="12">
                </div>
                <div class="menubar-item" data-menu="file">File</div>
                <div class="menubar-item" data-menu="links">Links</div>
                <div class="menubar-item" data-menu="view">View</div>
                <div class="menubar-item" data-menu="special">Special</div>
            </div>
            <div class="clock" id="clock"></div>
        </div>

        <div id="desktop" class="desktop">
            <!-- Desktop icons will be inserted here -->
        </div>

        <!-- Dropdown menus -->
        <div id="apple-menu" class="dropdown-menu">
            <div class="dropdown-item" onclick="showAboutWindow()">About This Website...</div>
        </div>
        
        <div id="file-menu" class="dropdown-menu">
            <div class="dropdown-item" onclick="openPage('BusTideDisplay')">Bus Tracker Display</div>
            <div class="dropdown-item" onclick="openPage('IsoTherm')">Isolated Thermocouple</div>
            <div class="dropdown-item" onclick="openPage('Citicar')">Citicar</div>
            <div class="dropdown-item" onclick="openPage('nedry')">Dennis Nedry</div>
            <div class="dropdown-item" onclick="openPage('CANconversion')">CAN Car Conversion</div>
            <div class="dropdown-item" onclick="openPage('QuicktakeLens')">Nikon Lens Adapter</div>
            <div class="dropdown-item" onclick="openPage('LinuxDevice')">The $15 Linux Machine</div>
            <div class="dropdown-item" onclick="openPage('dumb')">Portable Dumb Terminal</div>
            <div class="dropdown-item" onclick="openPage('MrRobot')">Mr. Robot Badge</div>
            <div class="dropdown-item" onclick="openPage('atapi')">Zip Drive Tower</div>
            <div class="dropdown-item" onclick="openPage('colorPCB')">Full Color Circuit Boards</div>
            <div class="dropdown-item" onclick="openPage('RGBgaming')">RGB Gaming Coaster</div>
            <div class="dropdown-item" onclick="openPage('FidgetSpinner')">Serial Fidget Spinner</div>
            <div class="dropdown-item" onclick="openPage('BaudBox')">Baud Box</div>
            <div class="dropdown-item" onclick="openPage('ShittyWall')">A Wall of Circuit Boards</div>
            <div class="dropdown-item" onclick="openPage('keyboard')">Silicone Membrane Keyboard</div>
            <div class="dropdown-item" onclick="openPage('Palmtop')">Injection Molded Palmtop</div>
            <div class="dropdown-item" onclick="openPage('MiniITX')">Retro-inspired Industrial Design</div>
            <div class="dropdown-item" onclick="openPage('BeBox')">Quarter-Scale Retrocomputing</div>
            <div class="dropdown-item" onclick="openPage('clamshell')">Hardened Clamshell Computer</div>
            <div class="dropdown-item" onclick="openPage('Tread')">3D Printed Tank Treads</div>
            <div class="dropdown-item" onclick="openPage('Porygon')">Porygon</div>
        </div>

        <div id="links-menu" class="dropdown-menu">
            <div class="dropdown-item" onclick="window.location.href='mailto:benchoff@gmail.com'">Email</div>
            <div class="dropdown-item" onclick="window.location.href='https://twitter.com/bbenchoff'">Twitter</div>
            <div class="dropdown-item" onclick="window.location.href='https://github.com/bbenchoff'">Github</div>
            <div class="dropdown-item" onclick="window.location.href='https://github.com/bbenchoff/CV/blob/main/Brian%20Benchoff%20-%20Resume.pdf'">Résumé</div>
        </div>

        <div id="view-menu" class="dropdown-menu">
            <div class="dropdown-item" onclick="setBackground('MacOS')">✔ MacOS</div>
            <div class="dropdown-item" onclick="setBackground('cats')">Cats</div>
            <div class="dropdown-item" onclick="setBackground('circuits')">Circuits</div>
            <div class="dropdown-item" onclick="setBackground('grass')">Grass</div>
            <div class="dropdown-item" onclick="setBackground('pebbles')">Pebbles</div>
            <div class="dropdown-item" onclick="setBackground('plaid')">Plaid</div>
        </div>

        <div id="special-menu" class="dropdown-menu">
            <div class="dropdown-item" onclick="toggleTheme()">Switch to Modern Theme</div>
        </div>
    </div>

    <script>
        // Add this at the start of your script
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const page = urlParams.get('page');
        if (page) {
            openPage(page);
        }
    });
    
        // Window management
        class Window {
                constructor(title, content, type = 'document', x = 20, y = 50) {
                this.element = document.createElement('div');
                this.element.className = 'window';
                if (type === 'folder') this.element.classList.add('folder-window');
                
                this.element.style.left = x + 'px';
                this.element.style.top = y + 'px';
                if (title === 'Macintosh HD') {
                    this.element.style.width = '500px'; 
                    this.element.style.height = '200px'; 
                } else {
                    this.element.style.width = '600px';
                    this.element.style.height = '400px';
                }

                this.element.innerHTML = `
                    <div class="window-titlebar">
                        <div class="window-close"></div>
                        <div class="window-title">${title}</div>
                    </div>
                    <div class="window-content">${content}</div>
                    <div class="window-resizer"></div>
                `;

                this.makeDraggable();
                this.makeCloseable();
                // Add resizable functionality
                    const resizer = this.element.querySelector('.window-resizer');
                    if (resizer) {
                        resizer.addEventListener('mousedown', (e) => {
                            e.preventDefault();
                            const startWidth = this.element.offsetWidth;
                            const startHeight = this.element.offsetHeight;
                            const startX = e.clientX;
                            const startY = e.clientY;
                            
                            const onMouseMove = (moveEvent) => {
                                const newWidth = startWidth + (moveEvent.clientX - startX);
                                const newHeight = startHeight + (moveEvent.clientY - startY);
                                this.element.style.width = `${newWidth}px`;
                                this.element.style.height = `${newHeight}px`;
                            };
                            
                            const onMouseUp = () => {
                                document.removeEventListener('mousemove', onMouseMove);
                                document.removeEventListener('mouseup', onMouseUp);
                            };
                            
                            document.addEventListener('mousemove', onMouseMove);
                            document.addEventListener('mouseup', onMouseUp);
                        });
                    };
                this.bringToFront();
                
                document.getElementById('desktop').appendChild(this.element);
            }

            makeDraggable() {
                const titlebar = this.element.querySelector('.window-titlebar');
                let isDragging = false;
                let currentX;
                let currentY;
                let initialX;
                let initialY;

                titlebar.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    initialX = e.clientX - this.element.offsetLeft;
                    initialY = e.clientY - this.element.offsetTop;
                    this.bringToFront();
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        e.preventDefault();
                        currentX = e.clientX - initialX;
                        currentY = e.clientY - initialY;
                        this.element.style.left = currentX + 'px';
                        this.element.style.top = currentY + 'px';
                    }
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });
            }

            makeCloseable() {
                const closeButton = this.element.querySelector('.window-close');
                closeButton.addEventListener('click', () => {
                    this.element.remove();
                });
            }

            bringToFront() {
                const windows = document.querySelectorAll('.window');
                let maxZ = 0;
                windows.forEach(win => {
                    const z = parseInt(win.style.zIndex || 0);
                    maxZ = Math.max(maxZ, z);
                    win.querySelector('.window-titlebar').style.background = 
                        'var(--system7-titlebar-inactive)';
                });
                this.element.style.zIndex = maxZ + 1;
                this.element.querySelector('.window-titlebar').style.background = 
                    'var(--system7-titlebar-active)';
            }
                // Debounced save state to prevent too many saves during drag operations
            debouncedSaveState() {
                if (this.saveStateTimeout) {
                    clearTimeout(this.saveStateTimeout);
                }
                this.saveStateTimeout = setTimeout(() => {
                    if (typeof StateManager !== 'undefined') {
                        StateManager.saveState();
                    }
                }, 500);
            }

            // Static method to restore a window from saved state
            static restore(windowState) {
                return new Window(
                    windowState.title,
                    windowState.content,
                    windowState.type,
                    0, // x and y are handled by options
                    0, // x and y are handled by options
                    windowState.position // Pass saved position as options
                );
            }
        }

 // File System Structure
const fileSystem = {
    'Macintosh HD': {
        type: 'folder',
        icon: 'hd-icon.png',
        contents: {
            'Software': {
                type: 'folder',
                icon: 'folder-icon.png',
                contents: {
                    'Dennis Nedry': {
                        type: 'document',
                        icon: 'jp.png',
                        file: 'nedry'
                    },
                    'Embedded SSL and GZIP': {
                        type: 'document',
                        icon: 'doc-icon.png',
                        file: 'BusTideDisplay'
                    },
                    'Reading ΔΣ DAQs': {
                        type: 'document',
                        icon: 'doc-icon.png',
                        file: 'IsoTherm'
                    },
                    'Instagram Clone': {
                        type: 'document',
                        icon: 'doc-icon.png',
                        file: 'InstaClone'
                    },
                    'IS31FL3741 Driver': {
                        type: 'document',
                        icon: 'doc-icon.png',
                        file: 'IS31FL3741'
                    },
                    'NT35510 TFT Driver': {
                        type: 'document',
                        icon: 'doc-icon.png',
                        file: 'NT35510'
                    },
                    'Terminal Parsing Library': {
                        type: 'document',
                        icon: 'doc-icon.png',
                        file: 'parser'
                    }
                }
            },
            'Hardware': {
                type: 'folder',
                icon: 'folder-icon.png',
                contents: {
                    'Isolated Thermocouple Reader': {
                        type: 'document',
                        icon: 'doc-icon.png',
                        file: 'IsoTherm'
                    },
                    'Nikon Lens Adapter': {
                        type: 'document',
                        icon: 'doc-icon.png',
                        file: 'QuicktakeLens'
                    },
                    'E-Ink Bus Station Display': {
                        type: 'document',
                        icon: 'doc-icon.png',
                        file: 'BusTideDisplay'
                    },
                    '$15 Linux Device': {
                        type: 'document',
                        icon: 'doc-icon.png',
                        file: 'LinuxDevice'
                    },
                    'Portable Dumb Terminal': {
                        type: 'document',
                        icon: 'doc-icon.png',
                        file: 'dumb'
                    },
                    'Mr. Robot Badge': {
                        type: 'document',
                        icon: 'doc-icon.png',
                        file: 'MrRobot'
                    },
                    'Zip Drive Tower': {
                        type: 'document',
                        icon: 'doc-icon.png',
                        file: 'atapi'
                    },
                    'Full Color Circuit Boards': {
                        type: 'document',
                        icon: 'doc-icon.png',
                        file: 'colorPCB'
                    },
                    'RGB Gaming Coaster': {
                        type: 'document',
                        icon: 'doc-icon.png',
                        file: 'RGBgaming'
                    },
                    'Serial Fidget Spinner': {
                        type: 'document',
                        icon: 'doc-icon.png',
                        file: 'FidgetSpinner'
                    },
                    'Baud Box': {
                        type: 'document',
                        icon: 'doc-icon.png',
                        file: 'BaudBox'
                    },
                    'A Wall of Circuit Boards': {
                        type: 'document',
                        icon: 'doc-icon.png',
                        file: 'ShittyWall'
                    }
                }
            },
            'CAD Design': {
                type: 'folder',
                icon: 'folder-icon.png',
                contents: {
                    'Silicone Keyboard': {
                        type: 'document',
                        icon: 'doc-icon.png',
                        file: 'keyboard'
                    },
                    'Injection Molded Palmtop': {
                        type: 'document',
                        icon: 'doc-icon.png',
                        file: 'Palmtop'
                    },
                    'Retro-inspired Industrial Design': {
                        type: 'document',
                        icon: 'doc-icon.png',
                        file: 'MiniITX'
                    },
                    'Quarter-Scale Retrocomputing': {
                        type: 'document',
                        icon: 'doc-icon.png',
                        file: 'BeBox'
                    },
                    'Hardened Clamshell Computer': {
                        type: 'document',
                        icon: 'doc-icon.png',
                        file: 'clamshell'
                    },
                    '3D Printed Tank Treads': {
                        type: 'document',
                        icon: 'doc-icon.png',
                        file: 'Tread'
                    },
                    'Porygon': {
                        type: 'document',
                        icon: 'doc-icon.png',
                        file: 'Porygon'
                    }
                }
            },
            'Access main security grid': {
                type: 'document',
                icon: 'jp.png'
            }
        }
    }
};


function handleDoubleClick(name) {

    // Check for Access main security grid specifically 
    if (name === 'Access main security grid') {
        const videoContent = `
            <video width="200" height="200" autoplay loop>
                <source src="/assets/video/TheKing.mp4" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        `;
        const jpWindow = new Window('The King', videoContent, 'document', 
                                     window.innerWidth / 2 - 125, 
                                     window.innerHeight / 2 - 125);
        jpWindow.element.style.width = '230px';
        jpWindow.element.style.height = '250px';
        return;
    }

    if (name === 'Macintosh HD') {
        const hdFolder = fileSystem['Macintosh HD'];
        new Window(name, createFolderContents(hdFolder), 'folder');
        return;
    }

    // Helper function to find an item in the file system
    function findItem(obj, searchName) {
        // Check direct contents first
        if (obj.contents && obj.contents[searchName]) {
            return obj.contents[searchName];
        }
        // If not found, search recursively through all folders
        for (const value of Object.values(obj.contents || {})) {
            if (value.contents) {
                const found = findItem(value, searchName);
                if (found) return found;
            }
        }
        return null;
    }

    // Look for the item in the file system
    const item = findItem(fileSystem['Macintosh HD'], name);

    if (item) {
        console.log('Found item:', item); // Debug log
        if (item.type === 'folder') {
            new Window(name, createFolderContents(item), 'folder');
        } else if (item.type === 'document') {
            fetch(`/pages/${item.file}.html`)
                .then(response => response.text())
                .then(content => {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = content;
                    const mainContent = tempDiv.querySelector('.main-content');
                    const windowContent = mainContent ? mainContent.innerHTML : content;
                    new Window(name, windowContent, 'document');
                })
                .catch(error => console.error('Error loading document:', error));
        }
    } else {
        // Check if it's an alias
        const fileMap = {
            'Bus Tracker Display': 'BusTideDisplay',
            'Isolated Thermocouple': 'IsoTherm',
            'Citicar': 'Citicar',
            'CAN Car Conversion': 'CANconversion'
        };
        
        if (fileMap[name]) {
            fetch(`/pages/${fileMap[name]}.html`)
                .then(response => response.text())
                .then(content => {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = content;
                    const mainContent = tempDiv.querySelector('.main-content');
                    if (mainContent) {
                        new Window(name, mainContent.innerHTML, 'document');
                    } else {
                        new Window(name, content, 'document');
                    }
                });
        } else if (name === 'JP') {
            const videoContent = `
                <video width="200" height="200" autoplay loop>
                    <source src="/assets/videos/TheKing.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            `;
            new Window('TheKing', videoContent, 'document', window.innerWidth / 2 - 100, window.innerHeight / 2 - 100);
            return;
        } else {
            console.log('Item not found:', name);
        }
    }
}

// Event delegation for all clicks
document.addEventListener('dblclick', (e) => {
    const icon = e.target.closest('.desktop-icon');
    if (!icon) return;
    
    const name = icon.dataset.name;
    console.log('Double clicked:', name); // Debug log
    handleDoubleClick(name);
});

// Create folder contents
function createFolderContents(folder) {
    let html = '';
    Object.entries(folder.contents).forEach(([name, item]) => {
        html += `
            <div class="desktop-icon" data-type="${item.type}" data-name="${name}">
                <img src="/assets/images/${item.icon}" alt="${name}">
                <div class="desktop-icon-label">${name}</div>
            </div>
        `;
    });
    return html;
}


function initializeDesktop() {
    const desktop = document.getElementById('desktop');
    const ICON_HEIGHT = 80; // Height of each icon including spacing
    let topPosition = 20; // Starting position from top
    
    // Add HD icon
    const hdIcon = createDesktopIcon(
        'Macintosh HD', 
        'hd-icon.png',
        false,
        { right: '20px', top: `${topPosition}px` }
    );
    desktop.appendChild(hdIcon);
    topPosition += ICON_HEIGHT;

    // Add aliases to main projects
    const projects = [
        { name: 'Bus Tracker Display', icon: 'muni.png' },
        { name: 'Isolated Thermocouple', icon: 'doc-icon.png' },
        { name: 'Citicar', icon: 'redcar.png' }, // Updated icon for Citicar
        { name: 'CAN Car Conversion', icon: 'can.png' }
    ];

    projects.forEach((project) => {
        const icon = createDesktopIcon(
            project.name,
            project.icon,
            true,
            { right: '20px', top: `${topPosition}px` }
        );
        desktop.appendChild(icon);
        topPosition += ICON_HEIGHT;
    });
}

function createDesktopIcon(name, icon, isAlias = false, position = {}) {
    const div = document.createElement('div');
    div.className = 'desktop-icon' + (isAlias ? ' alias' : '');
    Object.assign(div.style, position);

    div.innerHTML = `
        <img src="/assets/images/${icon}" alt="${name}">
        <div class="desktop-icon-label">${name}</div>
    `;

    // Add data attributes
    div.setAttribute('data-name', name);
    div.setAttribute('data-type', isAlias ? 'alias' : 'folder');

    return div;
}

        // Menu system
        document.querySelectorAll('.menubar-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const menuName = item.dataset.menu;
                const menu = document.getElementById(menuName + '-menu');
                if (menu) {
                    closeAllMenus();
                    menu.style.display = 'block';
                    menu.style.left = item.offsetLeft + 'px';
                    // No need to add top positioning as it's handled by CSS
                }
            });
        });

        function closeAllMenus() {
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.style.display = 'none';
            });
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.menubar-item')) {
                closeAllMenus();
            }
        });

        // Theme toggle function
        function toggleTheme() {
            window.location.href = '{{ site.baseurl }}/';
        }

        function showAboutWindow() {
            const content = `
                <div style="display: flex; align-items: center;">
                    <img src="/assets/images/moof.png" alt="Moof" style="width: 64px; height: 64px; margin-right: 20px;">
                    <div>
                        <p>This is a bit of CSS and Javascript running in a Jekyll theme. It's also my design portfolio.</p>
                    </div>
                </div>
            `;
            const aboutWindow = new Window('About This Website', content, 'document', window.innerWidth / 2 - 200, window.innerHeight / 2 - 100);
            aboutWindow.element.style.resize = 'none';
            aboutWindow.element.style.overflow = 'hidden';
            aboutWindow.element.style.width = '400px'; // Set width to 400px
            aboutWindow.element.style.height = '150px';
            aboutWindow.element.querySelector('.window-content').style.overflow = 'hidden';
        }

        // Initialize the interface
        initializeDesktop();

        function updateClock() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            document.getElementById('clock').textContent = `${hours}:${minutes}`;
        }

        setInterval(updateClock, 1000);
        updateClock();

        function setBackground(image) {
            const desktop = document.getElementById('desktop');
            const viewMenuItems = document.querySelectorAll('#view-menu .dropdown-item');
            viewMenuItems.forEach(item => {
                item.textContent = item.textContent.replace('✔ ', '');
            });
            switch (image) {
                case 'MacOS':
                    desktop.style.background = "url('/assets/images/backgrounds/MacOS.jpg') no-repeat center center fixed";
                    desktop.style.backgroundSize = 'cover';
                    document.querySelector('#view-menu .dropdown-item:nth-child(1)').textContent = '✔ MacOS';
                    break;
                case 'cats':
                    desktop.style.background = "url('/assets/images/backgrounds/cats.png') repeat";
                    desktop.style.backgroundSize = 'auto';
                    document.querySelector('#view-menu .dropdown-item:nth-child(2)').textContent = '✔ Cats';
                    break;
                case 'circuits':
                    desktop.style.background = "url('/assets/images/backgrounds/circuits.png') repeat";
                    desktop.style.backgroundSize = 'auto';
                    document.querySelector('#view-menu .dropdown-item:nth-child(3)').textContent = '✔ Circuits';
                    break;
                case 'grass':
                    desktop.style.background = "url('/assets/images/backgrounds/grass.png') repeat";
                    desktop.style.backgroundSize = 'auto';
                    document.querySelector('#view-menu .dropdown-item:nth-child(4)').textContent = '✔ Grass';
                    break;
                case 'pebbles':
                    desktop.style.background = "url('/assets/images/backgrounds/pebbles.png') repeat";
                    desktop.style.backgroundSize = 'auto';
                    document.querySelector('#view-menu .dropdown-item:nth-child(5)').textContent = '✔ Pebbles';
                    break;
                case 'plaid':
                desktop.style.background = "url('/assets/images/backgrounds/plaid.png') repeat";
                    desktop.style.backgroundSize = 'auto';
                    document.querySelector('#view-menu .dropdown-item:nth-child(6)').textContent = '✔ Plaid';
                    break;
            }
        }

        function openPage(page) {
            fetch(`/pages/${page}.html`)
                .then(response => response.text())
                .then(content => {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = content;
                    const mainContent = tempDiv.querySelector('.main-content');
                    const windowContent = mainContent ? mainContent.innerHTML : content;
                    new Window(page, windowContent, 'document');
                })
                .catch(error => console.error('Error loading page:', error));
        }
        // State management for System 7 interface
        const StateManager = {
            saveState() {
                const windows = Array.from(document.querySelectorAll('.window')).map(window => ({
                    title: window.querySelector('.window-title').textContent,
                    content: window.querySelector('.window-content').innerHTML,
                    position: {
                        left: window.style.left,
                        top: window.style.top,
                        width: window.style.width,
                        height: window.style.height,
                        zIndex: window.style.zIndex
                    },
                    type: window.classList.contains('folder-window') ? 'folder' : 'document'
                }));

                const desktop = {
                    background: document.getElementById('desktop').style.background,
                    backgroundSize: document.getElementById('desktop').style.backgroundSize
                };

                const state = {
                    windows,
                    desktop,
                    lastSaved: new Date().toISOString()
                };

                localStorage.setItem('system7State', JSON.stringify(state));
            },

            loadState() {
                const savedState = localStorage.getItem('system7State');
                if (!savedState) return;

                const state = JSON.parse(savedState);

                // Restore desktop background
                const desktop = document.getElementById('desktop');
                desktop.style.background = state.desktop.background;
                desktop.style.backgroundSize = state.desktop.backgroundSize;

                // Update menu checkmark
                const backgroundName = this.getBackgroundNameFromStyle(state.desktop.background);
                if (backgroundName) {
                    const viewMenuItems = document.querySelectorAll('#view-menu .dropdown-item');
                    viewMenuItems.forEach(item => {
                        item.textContent = item.textContent.replace('✔ ', '');
                        if (item.textContent.includes(backgroundName)) {
                            item.textContent = '✔ ' + item.textContent;
                        }
                    });
                }

                // Restore windows
                state.windows.forEach(windowState => {
                    const win = new Window(
                        windowState.title,
                        windowState.content,
                        windowState.type
                    );
                    
                    // Restore position and size
                    Object.assign(win.element.style, windowState.position);
                });
            },

            getBackgroundNameFromStyle(backgroundStyle) {
                const matches = backgroundStyle.match(/backgrounds\/(.*?)\./);
                return matches ? matches[1] : null;
            },

            // Auto-save state periodically
            startAutoSave(interval = 5000) {
                setInterval(() => this.saveState(), interval);
            }
        };

        // Add event listeners for state changes
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved state when page loads
            StateManager.loadState();
            
            // Start auto-saving
            StateManager.startAutoSave();

            // Save state when windows are closed
            document.addEventListener('click', (e) => {
                if (e.target.matches('.window-close')) {
                    setTimeout(() => StateManager.saveState(), 100);
                }
            });

            // Save state when background is changed
            const viewMenuItems = document.querySelectorAll('#view-menu .dropdown-item');
            viewMenuItems.forEach(item => {
                item.addEventListener('click', () => {
                    setTimeout(() => StateManager.saveState(), 100);
                });
            });
        });

        // Save state before page unload
        window.addEventListener('beforeunload', () => {
            StateManager.saveState();
        });

    </script>
</body>
</html>